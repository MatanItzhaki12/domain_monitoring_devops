---
- name: Configure Jenkins Master on AWS EC2
  hosts: all          # or the correct group from your aws_ec2 inventory
  become: yes

  collections:
    - community.docker

  vars:
    ADMIN_PASSWORD: "{{ lookup('env', 'ADMIN_PASSWORD') }}"
    DOCKERHUB_USER: "{{ lookup('env', 'DOCKERHUB_USER') }}"
    DOCKERHUB_PASS: "{{ lookup('env', 'DOCKERHUB_PASS') }}"
    GITHUB_USER: "{{ lookup('env', 'GITHUB_USER') }}"
    GITHUB_TOKEN: "{{ lookup('env', 'GITHUB_TOKEN') }}"
    jenkins_home: /var/jenkins_home
    jenkins_container_name: jenkins-master
    JCasC_url: "https://raw.githubusercontent.com/MatanItzhaki12/domain_monitoring_devops/refs/heads/main/infra/Ansible/jenkins.yaml"
    ansible_user: ubuntu
    ansible_ssh_private_key_file: "~/.ssh/keys/Group2-KeyPair.pem"  # Update with your key path

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Docker and curl
      apt:
        name:
          - docker.io
          - curl
          - python3-docker     # for docker_container module
        state: present

    - name: Create jenkins home directory
      file:
        path: "{{ jenkins_home }}"
        state: directory
        owner: root
        group: root
        mode: '0777'

    - name: Create casc_configs directory
      file:
        path: "{{ jenkins_home }}/casc_configs"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Download JCasC configuration file
      get_url:
        url: "{{ JCasC_url }}"
        dest: "{{ jenkins_home }}/casc_configs/jenkins.yaml"
        mode: '0644'

    - name: Download plugins configuration
      get_url:
        url: "https://raw.githubusercontent.com/MatanItzhaki12/domain_monitoring_devops/refs/heads/main/infra/Ansible/plugins.yaml"
        dest: "{{ jenkins_home }}/plugins.yaml"
        mode: '0644'

    - name: Generate plugins.txt from plugins.yaml
      shell: |
        grep -E '^  - ' {{ jenkins_home }}/plugins.yaml | sed 's/^  - //' > {{ jenkins_home }}/plugins.txt
      args:
        creates: "{{ jenkins_home }}/plugins.txt"

    - name: Create init.groovy.d directory for startup scripts
      file:
        path: "{{ jenkins_home }}/init.groovy.d"
        state: directory
        mode: '0755'

    - name: Create skip setup wizard script
      copy:
        dest: "{{ jenkins_home }}/init.groovy.d/01-skip-setup-wizard.groovy"
        mode: '0644'
        content: |
          #!groovy
          import jenkins.model.*
          import hudson.util.*
          import jenkins.install.*
          
          def instance = Jenkins.getInstance()
          
          // Skip setup wizard
          instance.setInstallState(InstallState.INITIAL_SETUP_COMPLETED)
          
          // Disable setup wizard
          def installUtil = instance.getSetupWizard()
          if (installUtil != null) {
              installUtil.completeSetup(instance)
          }
          
          instance.save()
          println "Setup wizard skipped successfully"

    - name: Create auto-approve script for plugin installations
      copy:
        dest: "{{ jenkins_home }}/init.groovy.d/02-approve-scripts.groovy"
        mode: '0644'
        content: |
          #!groovy
          import org.jenkinsci.plugins.scriptsecurity.scripts.*
          
          // Approve all pending script signatures automatically
          def instance = ScriptApproval.get()
          
          // Clear any pending approvals to start fresh
          instance.getPendingSignatures().each { ps ->
              instance.approveSignature(ps.signature)
          }
          
          instance.getPendingScripts().each { ps ->
              instance.approveScript(ps.getHash())
          }
          
          println "All scripts approved automatically"

    - name: Make Dockerfile with full automation
      copy:
        dest: "{{ jenkins_home }}/Dockerfile"
        content: |
          FROM jenkins/jenkins:lts-jdk17
          
          # Skip setup wizard and disable initial setup
          ENV JAVA_OPTS="-Djenkins.install.runSetupWizard=false \
                         -Djenkins.CLI.disabled=false \
                         -Dhudson.security.csrf.DefaultCrumbIssuer.EXCLUDE_SESSION_ID=true"
          ENV CASC_JENKINS_CONFIG=/var/jenkins_home/casc_configs/jenkins.yaml
          
          USER root
          
          # Install Docker CLI and dependencies
          RUN apt-get update && apt-get install -y \
              apt-transport-https \
              ca-certificates \
              curl \
              gnupg \
              lsb-release \
              vim \
              git && \
              curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg && \
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null && \
              apt-get update && \
              apt-get install -y docker-ce-cli docker-compose-plugin && \
              rm -rf /var/lib/apt/lists/*
          
          # Add jenkins user to docker group
          RUN groupadd -g 999 docker 2>/dev/null || true && \
              usermod -aG docker jenkins
          
          # Switch back to jenkins user
          USER jenkins
          
          # Copy plugins list and install all plugins
          COPY plugins.txt /usr/share/jenkins/ref/plugins.txt
          RUN jenkins-plugin-cli --plugin-file /usr/share/jenkins/ref/plugins.txt --verbose
          
          # Copy JCasC configuration
          COPY jenkins.yaml /var/jenkins_home/casc_configs/jenkins.yaml
          
          # Copy init scripts for setup wizard skip
          COPY init.groovy.d/*.groovy /usr/share/jenkins/ref/init.groovy.d/
          
          # Ensure proper permissions
          USER root
          RUN chown -R jenkins:jenkins /usr/share/jenkins/ref
          USER jenkins
          
          # Expose ports
          EXPOSE 8080 50000
    - name: Build Jenkins Docker image
      docker_image:
        name: jenkins/jenkins:lts
        build:
          path: "{{ jenkins_home }}"
  
    - name: Run fully automated Jenkins container
      docker_container:
        name: "{{ jenkins_container_name }}"
        image: jenkins/jenkins:lts
        state: started
        restart_policy: always
        privileged: yes
        user: root
        ports:
          - "8080:8080"
          - "50000:50000"
        volumes:
          - "{{ jenkins_home }}:/var/jenkins_home"
          - "/var/run/docker.sock:/var/run/docker.sock"
        env:
          # Skip setup wizard completely
          JAVA_OPTS: "-Djenkins.install.runSetupWizard=false -Djenkins.CLI.disabled=false -Dhudson.security.csrf.DefaultCrumbIssuer.EXCLUDE_SESSION_ID=true"
          CASC_JENKINS_CONFIG: "/var/jenkins_home/casc_configs/jenkins.yaml"
          
          # User credentials
          ADMIN_PASSWORD: "{{ ADMIN_PASSWORD }}"
          DEVOPS_PASSWORD: "{{ lookup('env', 'DEVOPS_PASSWORD') | default('devops123', true) }}"
          
          # External service credentials
          DOCKERHUB_USER: "{{ DOCKERHUB_USER }}"
          DOCKERHUB_PASS: "{{ DOCKERHUB_PASS }}"
          GITHUB_USER: "{{ GITHUB_USER }}"
          GITHUB_TOKEN: "{{ GITHUB_TOKEN }}"
          
          # Jenkins configuration
          JENKINS_URL: "{{ lookup('env', 'JENKINS_URL') | default('http://localhost:8080', true) }}"
          ADMIN_EMAIL: "{{ lookup('env', 'ADMIN_EMAIL') | default('admin@example.com', true) }}"
          REPO_URL: "{{ lookup('env', 'REPO_URL') | default('https://github.com/MatanItzhaki12/domain_monitoring_devops.git', true) }}"
          
          # AWS credentials for Terraform
          AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') | default('', true) }}"
          AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') | default('', true) }}"
        healthcheck:
          test: ["CMD-SHELL", "curl -f http://localhost:8080/login || exit 1"]
          interval: 30s
          timeout: 10s
          retries: 5
          start_period: 180s



    - name: Wait for Jenkins container to be healthy
      command: docker inspect --format='{{`{{.State.Health.Status}}`}}' {{ jenkins_container_name }}
      register: health_status
      until: health_status.stdout == "healthy"
      retries: 30
      delay: 10
      changed_when: false

    - name: Wait for Jenkins API to respond
      uri:
        url: "http://localhost:8080/api/json"
        status_code: 200,403
        timeout: 5
      register: jenkins_api
      retries: 30
      delay: 10
      until: jenkins_api.status in [200, 403]

    - name: Verify JCasC configuration loaded
      command: docker logs {{ jenkins_container_name }}
      register: jenkins_logs
      changed_when: false

    - name: Check if setup wizard was skipped
      shell: docker logs {{ jenkins_container_name }} | grep -i "setup wizard" || true
      register: setup_check
      changed_when: false

    - name: Display Jenkins deployment status
      debug:
        msg:
          - "=========================================="
          - "Jenkins Fully Automated Deployment Complete!"
          - "=========================================="
          - ""
          - "Access Information:"
          - "  URL: http://{{ ansible_host }}:8080"
          - ""
          - "Login Credentials:"
          - "  Admin User: admin"
          - "  Admin Password: {{ ADMIN_PASSWORD }}"
          - "  DevOps User: devops"
          - "  DevOps Password: {{ lookup('env', 'DEVOPS_PASSWORD') | default('devops123', true) }}"
          - ""
          - "Features:"
          - "  ✓ Setup wizard completely skipped"
          - "  ✓ All plugins installed automatically"
          - "  ✓ Users pre-configured with role-based access"
          - "  ✓ Docker-in-Docker enabled"
          - "  ✓ Credentials pre-configured (GitHub, DockerHub, AWS)"
          - "  ✓ Pipeline job auto-created"
          - ""
          - "Ready to use - No manual configuration needed!"
          - "=========================================="
